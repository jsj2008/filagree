import '../ui'
import '../mesh'

port = 9999

####### net

client = [

    'friends' : (sys.load('friends') or []),
    'roster' : [],
    'unread' : [],
    'mesh' : Mesh,

    'handle_message' : function(self, socket, mc1)
        if (mc1.event == 'greet') then
            creds = sys.form_get(self.ui)
            return ['event' : self.entrance] + creds
        else if (mc1.event == 'signup') or (mc1.event == 'signin') then
            self.handle_signin(socket, mc1)
        else if mc1.event == 'online' then
            self.handle_online(mc1.online)
        else if mc1.event == 'chat' then
            self.handle_chat(mc1.chat, mc1.from)
        else
            self.sync.handle_message(socket, mc1)
        end
    end,

    'connected' : function(self, socket)
        self.mesh.print('connected ' + socket)
        self.server = socket
    end,


    'handle_signin' : function(self, socket, mc3)
        if mc3.result then
            self.roster = mc3.friends
            self.main()
        else
            sys.ui_set(self.ui.error, mc3.error)
        end
    end

]


####### ui

client.select = function(self)

    self.transcript = ''
    row = sys.args()[1]
    peer = self.roster[row]
    send = function(self)(peer)
        text = sys.form_get(self.ui).sezme
        msgtext = ['from':self.mesh.id, 'to':peer, 'event':'chat', 'chat':text]
        self.update_transcript('you', text)
        self.mesh.send(self.server, msgtext)
    end

    self.ui = sys.ui(self,
                    ['horizontal',

                        ['table', 'name':'roster', 'list':self.roster, 'logic':self.select, 'hfill':true, 'width':0.25],
                        ['vertical',
                            ['input', 'name':'transcript', 'multiline':true, 'readonly':true, 'hfill':true],
                            ['input', 'name':'sezme'],
                            ['button', 'text':'send', 'logic':send],
                        ]
                    ])
    self.peer = peer

end

client.update_transcript = function(self, from, text)
    if self.transcript.length then
        self.transcript = self.transcript + '\n'
    end
    self.transcript = self.transcript + from +':'+ text
    sys.ui_set(self.ui.transcript, self.transcript)
end

client.handle_chat = function(self, chat, from)

    if from == self.peer then
        self.update_transcript(from, chat)
    else
        self.unread[from] = self.unread + [chat]
        roster = [r+ '(' + self.unread[r].length + ')' for r in self.roster]
        sys.ui_set(self.ui.roster, roster)
    end

end

client.send = function(self, other)

    text = sys.form_get(self.ui).sezme
    msgtext = ['event':'text', 'text':text]
    self.mesh.send_to(peer, msgtext)

end

client.settings = function(client)

    client.ui = sys.ui(client, ['vertical',

                        ['form', 'display name', 'username', 'password'],

                        ['horizontal',
                            ['button', 'text':'save',   'logic':sys.save(sys.form_get(client.ui), 'settings')],
                            ['button', 'text':'cancel', 'logic':client.main],
                            ['button', 'text':'logout', 'logic':client.main],
                        ],

                        client.w, client.h
                    ])

    f = sys.load('settings')
    sys.form_set(f)
end

client.main = function(self)

    self.mesh.print('roster=' + self.roster)

    self.ui = sys.ui(self, ['vertical',

                    ['horizontal',
                        ['button', 'text':'add',      'logic':self.add],
                        ['button', 'text':'settings', 'logic':self.settings],
                    ],

                    ['table', 'name':'roster', 'list':self.roster, 'logic':self.select],

                    self.w, self.h
                ])
end

client.add = function(self)

    self.ui = sys.ui(self,

                    ['vertical',

                        ['form', 'username'],

                        ['horizontal',
                            ['button', 'text':'add',       'logic':self.added],
                            ['button', 'text':'nevermind', 'logic':self.main],
                        ],

                        self.w, self.h
                    ])
end


client.added = function(self)
    friend = sys.form_get(self.ui).username
    self.friends = self.friends + friend
    sys.print('fz ' + friend + ' -- ' + self.friends)
    mc4 = ['event' : 'friends', 'friends' : self.friends]
    self.mesh.send_to('server', mc4)
    self.main()
end

client.signin = function(self, entrance)
    self.entrance = entrance or 'signin'
    id = sys.form_get(self.ui).username
    self.mesh = self.mesh.init(id, self.port, [self])
    self.mesh.connect()
end

client.signup = function(self)
    self.signin('signup')
end

client.ui_login = function(self)
    self.ui = sys.ui(self, ['vertical',
                                 ['form', 'username', 'password'],
                                 ['horizontal',
                                     ['button', 'text':'signin', 'logic':self.signin],
                                     ['button', 'text':'signup', 'logic':self.signup],
                                 ],
                                 self.w, self.h
                            ])
end

client.ui_login()
sys.loop()

