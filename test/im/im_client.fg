port = 9996

import '../mesh'
import '../ui'

####### net

client = [

    'port' : port,
    'w':('w':240), 'h':('h':320),
    'friends' : [],
    'roster' : [],

    'connect' : function(self)
        self.id = sys.form_get(self.ui).username
        sys.connect('127.0.0.1', self.port, self)
    end,

    'handle_message' : function(self, socket, mc1)
        if (mc1.event == 'greet') then
            sys.print('sys=' + sys)
            creds = sys.form_get(self.ui)
            return ['event' : self.entrance] + creds
        else if (mc1.event == 'signup') or (mc1.event == 'signin') then
            self.handle_signin(socket, mc1)
        else if (mc1.event = 'online') then
            self.handle_online(mc1.online)
        end
    end,

    'handle_online' : function(self, online)
        self.roster = online or self.roster
        #sys.ui_set(self.ui.roster, online)
        self.main()
    end,

    'handle_signin' : function(self, socket, mc3)
        if mc3.result then
            self.roster = mc3.online or self.roster
            self.main()
        else
            sys.ui_set(self.ui.error, error = mc2.error)
        end
    end

] + Mesh


####### ui

ctx = ['w':('w':240), 'h':('h':320),
       'client' : client,
       'port' : port,
       'friends' : (sys.load('friends') or []),
      ]

ctx.select = function(ctx)
    sys.print('select ' + sys.args()[1])
end

ctx.settings = function(ctx)

    ctx.ui = sys.ui(ctx, ['vertical',

                        ['form', 'display name', 'username', 'password'],

                        ['horizontal',
                            ['button', 'text':'save',   'logic':sys.save(sys.form_get(ctx.ui), 'settings')],
                            ['button', 'text':'cancel', 'logic':ctx.main],
                            ['button', 'text':'logout', 'logic':ctx.main],
                        ],

                        ctx.w, ctx.h
                    ])

    f = sys.load('settings')
    sys.form_set(f)
end

client.main = function(self)

    sys.ui(self, ['vertical',

                    ['horizontal',
                        ['button', 'text':'add',      'logic':self.add],
                        ['button', 'text':'settings', 'logic':self.settings],
                    ],

                    ['table', 'name':'roster', 'list':self.roster, 'logic':self.select],

                    self.w, self.h
                ])
end

client.add = function(self)

    self.ui = sys.ui(self, ['vertical',

                        ['form', 'username'],

                        ['horizontal',
                            ['button', 'text':'add',       'logic':self.added],
                            ['button', 'text':'nevermind', 'logic':self.main],
                        ],

                        self.w, self.h
                    ])
end

client.added = function(self)
    friend = sys.form_get(self.ui).username
    self.friends = self.friends + friend
    sys.print('fz ' + friend + ' -- ' + self.friends)
    #sys.save(self.friends, 'friends')
    mc4 = ['event' : 'friends', 'friends' : self.friends]
    self.send_to('server', mc4)
end

ctx.signin = function(self, entrance)
    self.net.entrance = entrance or 'signin'
    self.net.connect()
end

ctx.signup = function(self)
    self.signin('signup')
end

client.ui = sys.ui(ctx, ['vertical',

                         ['form', 'username', 'password'],

                         ['horizontal',
                             ['button', 'text':'signin', 'logic':ctx.signin],
                             ['button', 'text':'signup', 'logic':ctx.signup],
                         ],

                         ctx.w, ctx.h
             ])

ctx.net = client

####### main

sys.loop()
