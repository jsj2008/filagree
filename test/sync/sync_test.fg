####### test_sync.fg

# to run, launch server and two clients, 'client1' and 'client2'


import 'sync' # for host and port
import '../test_director'


director = [

    'run_tests' : function(self)

        #self.crud_file()
        #self.crud_folder()
        self.large_file()

    end,

    #
    # test to create, rename, update, delete files
    #

    'crud_file' : function(self)

        # create
        self.sync_direct('client1', 'update', 'a.txt', '123')
        self.sync_direct('client1', 'verify', 'a.txt', '123')
        self.sync_direct('server1', 'verify', 'a.txt', '123')
        self.sync_direct('client2', 'verify', 'a.txt', '123')

        # rename
        self.sync_direct('client1', 'rename', 'a.txt', nil, 'b.txt')
        self.sync_direct('client1', 'verify', 'a.txt')
        self.sync_direct('server1', 'verify', 'a.txt')
        self.sync_direct('client2', 'verify', 'a.txt')
        self.sync_direct('client1', 'verify', 'b.txt', '123')
        self.sync_direct('server1', 'verify', 'b.txt', '123')
        self.sync_direct('client2', 'verify', 'b.txt', '123')

        # update
        self.sync_direct('client2', 'update', 'b.txt', '456')
        self.sync_direct('client2', 'verify', 'b.txt', '456')
        self.sync_direct('server1', 'verify', 'b.txt', '456')
        self.sync_direct('client1', 'verify', 'b.txt', '456')

        #delete
        self.sync_direct('client1', 'delete', 'b.txt')
        self.wait() # wait for delete to propogate
        self.sync_direct('client1', 'verify', 'b.txt')
        self.sync_direct('server1', 'verify', 'b.txt')
        self.sync_direct('client2', 'verify', 'b.txt')

    end,

    #
    # test to create, rename, update, delete folders
    #

    'crud_folder' : function(self)

        # create
        self.sync_direct('client1', 'folder', 'a0/a00')
        self.sync_direct('client1', 'folder', 'a0/a01')
        self.sync_direct('client1', 'update', 'a0/a01/a.txt', '123')
        self.sync_direct('client1', 'verify', 'a0/a01/a.txt', '123')

        # rename
        self.sync_direct('client1', 'rename', 'a0', nil, 'a1')
        self.sync_direct('client2', 'verify', 'a1/a01/a.txt', '123')

        #delete
        self.sync_direct('client2', 'delete', 'a1')
        self.sync_direct('client1', 'verify', 'a1/a01/a.txt')

    end,

    #
    # test to transfer large files
    #

    # todo: 1) dynamic chunk size in sync.fg, 2) reuse buffer in node.c, 3) staging area in sync.fg 

    'large_file' : function(self)

        test_xfer = function(self, size)

            dir = 'client1'
            filename = (size/1000) + ' KB' # OSX doesn't divide by 1024
            self.create_file(dir, filename, size)
            self.sync_direct('client1', 'verify', filename, nil, nil, size)
            self.sync_direct('server1', 'verify', filename, nil, nil, size)
            self.sync_direct('client2', 'verify', filename, nil, nil, size)

        end

        size = 1000 # bytes
        while size <= (1024*1000) # 1MB
            test_xfer(self, size)
            size = size * 2
        end

    end,


    # creates local file of random content, size in KB
    'create_file' : function(self, dir, name, size, content)
        if size then
            self.local_step('fork', true, '/bin/dd', 'if=/dev/urandom', 'bs=1', 'count=' + size, 'of=' + dir +'/'+ name)
        else if dir and name then
            self.local_step('write', dir +'/'+ name, content)
        else
            self.print('create_file usage error')
        end
    end,

    'wait' : function(self)
        self.local_step('wait')
    end,

    # perform a test step, instead of asking another client to
    'step' : function(self, params)
        self.mesh.print('step '   + params)

        action = params[0]

        if action == 'write' then # write contents to file
            sys.write(params[1], params[2])

        else if action == 'wait' then # wait so as to ignore file event
            sys.sleep(2000)
        end

    end,

    'sync_direct' : function(self, whom, action, path, content, path2, size)

        title = action +' '+ path
        if path2 then
            title = title +' to '+ path2
        end

        self.direct(title, whom, action, ['path':path, 'content':content, 'path2':path2, 'size':size])

    end,


] + test_director

port = 1999
mesh = Mesh.init(director.id, port, [director])
director.launch(mesh, 2)
